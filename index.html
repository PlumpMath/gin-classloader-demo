<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>GinBridgeClassLoader Demo by e-karge</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>GinBridgeClassLoader Demo</h1>
        <h2></h2>
        <a href="https://github.com/e-karge/gin-classloader-demo" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>gin-classloader-demo</h1>

<p>This code reproduces a problem while using gin within a custom classloader
and provides three possible solutions.</p>

<p>Running the GWT-Compiler within a classloader other than the system classloader may lead
to a very confusing error message stating that a gin-injector is supposedly not derived
from Ginjector. Cause for that is a comparison between classes from different classloaders
found in the following snippet from the <code>GinjectorGenerator</code> class:</p>

<pre><code>@SuppressWarnings("unchecked")
// Due to deferred binding we assume that the requested class has to be a ginjector.
private Class&lt;? extends Ginjector&gt; getGinjectorType(String requestedClass)
    throws ClassNotFoundException {

  // We choose not to initialize ginjectors since we do not require it for reflective analysis and
  // some people statically call GWT.create in them (which is illegal during Gin generator runs).
  Class&lt;?&gt; type = loadClass(requestedClass, false);
  if (!Ginjector.class.isAssignableFrom(type)) {
   throw new IllegalArgumentException("The type passed does not inherit from Ginjector - "
       + "please check the deferred binding rules.");
  }

  return (Class&lt;? extends Ginjector&gt;) type;
}
</code></pre>

<p>More precisely it's the <code>Ginjector.class.isAssignableFrom(type)</code> comparison that fails.</p>

<p>I came up with a bunch of possible solution to the problem:</p>

<ol>
<li>Use the <code>GinBridgeClassLoader</code> that is also used to load the <code>type</code> to load the Ginjector interface
instead of comparing against <code>Ginjector.class</code>.</li>
<li>Use the own classloader (namely <code>GinBridgeClassLoader.class.getClassLoader()</code>) as
parent classloader of the <code>GinBridgeClassLoader</code>.</li>
<li>Use the current thread's context classloader as parent of the <code>GinBridgeClassLoader</code>
</li>
</ol><p>The first solution does not work, because it is not feasible to access the injector's annotations later on.
Since GWT uses the current thread's context classloader to load the GinjectorGenerator, the second and third
solution are identical for all practical purposes.</p>

<h2>Build</h2>

<p>You can use Maven as well as Ant to build the project.</p>

<h3>Maven</h3>

<p>To build the project simply run from the project root</p>

<pre><code>mvn package
</code></pre>

<p>To run the demo run</p>

<pre><code>mvn verify
</code></pre>

<p>The provided fixes are selectable via profiles. To run the Demo with the first applied run</p>

<pre><code>mvn verify -P fix-1
</code></pre>

<p>The same goes for the second and third fix.</p>

<h3>Ant</h3>

<p>Before you can run the Ant build you need to put the following jars into the "lib" directory in the project root</p>

<ul>
<li>aopalliance-1.0.jar</li>
<li>gin-2.0.0.jar</li>
<li>guice-3.0.jar</li>
<li>guice-assistedinject-3.0.jar</li>
<li>gwt-dev-2.5.1.jar</li>
<li>gwt-user-2.5.1.jar</li>
<li>javax.inject-1.jar</li>
<li>json-20090211.jar</li>
<li>validation-api-1.0.0.GA.jar</li>
<li>validation-api-1.0.0.GA-sources.jar</li>
</ul><p>To build the project just run ant</p>

<pre><code>ant
</code></pre>

<p>there is a bunch of shell scripts to run the demo afterwards (namely <code>run-demo.sh</code> and <code>run-demo-with-fix-[123].sh</code>).</p>

<h1>Authors</h1>

<p>Eric Karge <a href="mailto:eric.karge@hypoport.de">eric.karge@hypoport.de</a></p>

<h1>License</h1>

<pre><code> Copyright 2012 Eric Karge

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
</code></pre>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/e-karge/gin-classloader-demo/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/e-karge/gin-classloader-demo/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/e-karge/gin-classloader-demo"></a> is maintained by <a href="https://github.com/e-karge">e-karge</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>